# 金融智能问答系统：元数据与数据源映射体系设计方案 (V2.0)

## 一、 建设背景与总体架构

本方案旨在构建一套**统一、可解释、可扩展**的金融语义体系，以支撑大模型（LLM）驱动的智能问答与查数能力。

针对传统“静态宽表映射”灵活性不足的问题，本方案采用 **“大模型智能体 (LLM Agent) + 语义工具层 (Semantic Tool Layer)”** 架构。核心在于构建一个**统一语义层**，将底层异构 API（数据库、搜索引擎、图谱）封装为 LLM 可理解的原子能力（Tools）。

### 1.1 核心分层架构

1. **意图路由层 (Intent Router)**
    * 负责识别用户意图（查数计算、关系推理、文档检索、混合查询）。
    * 负责规划执行路径（Planning），决定调用哪些工具。
2. **语义元数据层 (Semantic Layer)**
    * 定义实体、事件、关系及指标的标准语义，解决业务语言与技术实现的“认知对齐”问题。
3. **工具执行层 (Tool Execution)**
    * 将语义请求转化为具体的 API 调用、SQL 或 DSL。
    * 包含“Data Tool”、“Graph Tool”、“RAG Tool”三大核心工具集。
4. **物理数据层 (Physical Data)**
    * 包括关系型/OLAP数据库（存储指标）、图数据库（存储关系）、向量数据库（存储非结构化文档）。

---

## 二、 核心语义模型抽象 (Semantic Model)

为了支持复杂的金融逻辑推理，采用 **“实体-关系-事件”图谱化模型**，并将**文档**作为独立实体管理。

### 2.1 实体 (Entity)

现实世界的逻辑挂载点。

* **定义**：具有唯一标识符（ID）的客观主体。
* **核心类型**：
  * **主体类**：`Company` (企业), `Person` (自然人/高管), `Government` (监管机构/政府)
  * **标的类**：`Instrument` (证券标的，如股票、债券、基金)
  * **载体类**：`Document` (文档对象，详见 2.4)
* **关键元数据**：
  * `synonyms`: 同义词表（用于实体链接，如：万科A <-> 000002.SZ <-> 万科集团）。

### 2.2 事件 (Event) —— [核心设计：节点化]

将事件视为图谱中的**节点 (Node)**，而非单纯依附于实体的属性字段。

* **定义**：在特定时间发生的独立事实。
* **核心类型**：`Default` (违约), `Lawsuit` (诉讼), `IPO` (上市), `RatingChange` (评级变更), `M&A` (并购)。
* **属性**：`event_id`, `event_date` (发生时间), `status` (状态), `amount` (涉及金额)。
* **设计优势**：支持多主体参与（例如：一场并购涉及买方、卖方、标的方，通过关系连接不同实体）。

### 2.3 关系 (Relation) —— [核心设计：双层关系]

关系是连接实体与实体、实体与事件的桥梁，必须具备方向性和时效性。

* **类型 A：结构性关系 (Structural Relation)**
  * **连接对象**：`Entity -> Entity`
  * **典型范例**：`SubsidiaryOf` (子公司), `SupplierOf` (供应商), `CompetitorOf` (竞争对手)。
  * **属性**：`weight` (如持股比例), `valid_period` (关系生效区间)。
* **类型 B：参与性关系 (Participatory Relation)**
  * **连接对象**：`Entity -> Event`
  * **核心属性**：**`Role` (角色)**
  * **典型范例**：
    * `Entity:恒大地产` --[`Role:Issuer`]--> `Event:债券违约`
    * `Entity:招商银行` --[`Role:Underwriter`]--> `Event:债券违约`
    * `Entity:公司A` --[`Role:Plaintiff`]--> `Event:合同纠纷诉讼`

### 2.4 文档 (Document) —— [核心设计：独立建模]

文档是信息的**载体**，事件是信息的**事实**。两者解耦。

* **定义**：非结构化数据的存储单元（公告、研报、新闻、法律文书）。
* **关键关系**：
  * `Proven_By` (Event -> Document)：事件由该文档证实/披露。
  * `Mentioned_In` (Entity -> Document)：实体在该文档中被提及。
* **应用场景**：解决“溯源”问题。用户问“根据什么说它违约了？”，系统通过 `Event -> Proven_By -> Document` 找到原始公告。

### 2.5 字段与指标 (Field & Metrics) —— [核心设计：指标中台化]

将属性分为静态与动态两类。

* **静态属性 (Attribute)**：值相对稳定。如 `Company.sector` (行业), `Bond.maturity_date` (到期日)。
* **动态指标 (Metric)**：必须依赖**维度 (Dimensions)** 才能确定的数值。
  * **范例**：`Revenue` (营收), `NetProfit` (净利润), `ClosePrice` (收盘价)。
  * **维度约束**：`Time` (报告期/日期), `Scope` (合并报表/母公司报表), `Unit` (币种)。

---

## 三、 API 映射与工具定义 (API Mapping Strategy)

为了实现“自然语言 -> API”的灵活映射，系统不直接暴露物理表结构，而是注册三类**标准工具 (Standardized Tools)** 供 LLM 调用。

### 3.1 Data Tool (查数工具)

用于查询静态属性和动态指标。

* **Tool Name**: `get_financial_data`
* **Function Schema**:

    ```json
    {
      "name": "get_financial_data",
      "description": "查询公司的财务数据、市场行情或基础属性。适用于查询营收、利润、股价、估值等。",
      "parameters": {
        "type": "object",
        "properties": {
          "entity": {
            "type": "string",
            "description": "公司名称或代码，如 '茅台', '600519'"
          },
          "metric": {
            "type": "string",
            "enum": ["revenue", "net_profit", "close_price", "pe_ratio", "total_assets"],
            "description": "指标的标准名称"
          },
          "period": {
            "type": "string",
            "description": "时间周期，如 '2023', '2023Q1', 'latest'"
          },
          "scope": {
            "type": "string",
            "enum": ["consolidated", "parent"],
            "default": "consolidated",
            "description": "报表口径：合并报表或母公司报表"
          }
        },
        "required": ["entity", "metric"]
      }
    }
    ```

* **后端逻辑**：LLM 填槽 -> 指标服务 (Metric Store) -> 生成 SQL (ClickHouse/StarRocks)。

### 3.2 Graph Tool (图谱/关系工具)

用于查询实体间的关系或实体参与的事件。

* **Tool Name**: `explore_relations`
* **Function Schema**:

    ```json
    {
      "name": "explore_relations",
      "description": "查询实体的关联方（股东、子公司、供应商）或参与的事件（违约、诉讼、IPO）。",
      "parameters": {
        "type": "object",
        "properties": {
          "source_entity": { "type": "string" },
          "relation_type": {
            "type": "string",
            "enum": ["shareholder", "subsidiary", "supplier", "participant_in_event", "related_instrument"],
            "description": "关系类型"
          },
          "target_type": {
            "type": "string",
            "enum": ["Company", "Person", "Event", "Instrument"],
            "description": "目标节点的类型"
          },
          "role_filter": {
            "type": "string",
            "description": "在事件中的角色，如 'issuer' (发行人), 'plaintiff' (原告)"
          }
        },
        "required": ["source_entity"]
      }
    }
    ```

* **后端逻辑**：LLM 填槽 -> 图查询引擎 -> 生成 Cypher/Gremlin (Neo4j/NebulaGraph)。

### 3.3 RAG Tool (文档检索工具)

用于非结构化内容的全文检索。

* **Tool Name**: `search_documents`
* **Function Schema**:

    ```json
    {
      "name": "search_documents",
      "description": "搜索公告、研报或新闻原文。用于溯源、查找原因或回答非结构化细节。",
      "parameters": {
        "type": "object",
        "properties": {
          "keywords": { "type": "string", "description": "搜索关键词" },
          "doc_type": {
            "type": "string",
            "enum": ["announcement", "research_report", "news"],
            "description": "文档类型"
          },
          "entity_filter": { "type": "string", "description": "限定涉及的实体" },
          "date_range": { "type": "string", "description": "发布时间范围" }
        },
        "required": ["keywords"]
      }
    }
    ```

* **后端逻辑**：LLM 填槽 -> 向量检索引擎 (Milvus/ES) -> 混合检索 (Dense+Sparse) -> Rerank。

---

## 四、 关键流程与中间件设计

### 4.1 词汇注入与归一化 (Vocabulary Injection)

解决用户口语与 API 标准参数不一致的问题。

* **痛点**：用户输入“TMT行业”、“海航系”，但 API 需要标准 ID。
* **解决方案**：引入 **Entity Linking / NLU 中间件**，在 Tool 调用前拦截。
  * `Input: "TMT"` -> `Middleware Lookup` -> `Output ID: "SW_Industry_801750"`
  * `Input: "海航系"` -> `Graph Lookup` -> `Output ID List: ["HNA_Group", "HNA_Tech", ...]`

### 4.2 结果合成与可解释性

* LLM 必须在回答中引用数据来源。
* **System Prompt 规范**：
    > 当你使用工具获取数据时，请在回答中明确标注。
    > 格式示例：“根据**2023年年报**[Doc_ID:123]，营收为100亿（来源：**财务数据库**）。”

---

## 五、 场景交互示例 (Trace)

**用户提问**：“恒大地产最近有哪些违约事件？涉及哪些理财产品？我想看下具体的公告。”

**系统执行链 (Chain of Thought):**

1. **意图识别**：检测到复合意图 -> 需要调用 `Graph Tool` (查事件/产品) 和 `RAG Tool` (查公告)。
2. **Step 1: 查事件 (Graph Tool)**
    * *Action*: `explore_relations(source_entity="恒大地产", relation_type="participant_in_event", target_type="Event", role_filter="issuer")`
    * *Filter*: 后端过滤 `Event.status = 'Default'`
    * *Result*: `[{id: 1001, name: "债券违约"}, {id: 1002, name: "理财兑付逾期"}]`
3. **Step 2: 查关联产品 (Graph Tool - Multi-hop)**
    * *Action*: `explore_relations(source_entity="Event_1002", relation_type="related_instrument", target_type="Instrument")`
    * *Result*: `["恒大财富尊享系列", "20恒大01"]`
4. **Step 3: 查文档 (RAG Tool)**
    * *Action*: `search_documents(keywords="恒大 违约 兑付", entity_filter="恒大地产", doc_type="announcement")`
    * *Result*: `[{title: "关于无法按期兑付的公告", url: "..."}, {title: "风险提示公告", url: "..."}]`
5. **最终响应**：
    LLM 汇总上述三个步骤的 JSON 结果，生成自然语言回答，并附带文档链接。

---

## 六、 总结

本设计方案通过 **Event 节点化** 和 **API 语义封装**，实现了以下目标：

1. **解耦性**：前端自然语言与后端物理数据库结构解耦，仅通过 Schema 交互。
2. **推理能力**：支持复杂的“实体-事件-实体”传导链分析。
3. **可溯源**：明确区分事实（Event）与证据（Document），满足金融审计需求。
