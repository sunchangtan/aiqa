# 金融智能问答系统 - 统一语义元数据层 DDL (PostgreSQL)

> **Version**: 3.0
> **Date**: 2025-12-10
> **Database**: PostgreSQL
> **说明**: 本文档以 Markdown 形式整理统一语义元数据层及数据源映射相关 DDL，全部采用 PostgreSQL 语法，用于智能问答系统的语义层与物理层建模。

---

## 1. 公共函数与约定

### 1.1 自动更新时间戳触发器函数

用于在涉及 `updated_at` 字段的表中，自动更新时间戳。

```sql
CREATE OR REPLACE FUNCTION update_timestamp_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';
```

---

## 2. 语义元数据层（Semantic Metadata Layer）

### 2.1 表：`biz_metadata`（统一业务语义元数据表）

定义系统中的所有原子业务概念：实体、事件、关系、指标/字段。

- 承载 NLIR 中的 `name` + `meta_type` 映射。
- 提供业务口径、语义类型、数据类型等信息。

```sql
CREATE TABLE biz_metadata (
    id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- 2.1 唯一标识与名称
    code            VARCHAR(255) NOT NULL, -- 全局唯一业务编码
    name            VARCHAR(255) NOT NULL, -- 标准中文名称 (NLIR 映射目标)
    description     TEXT NULL,             -- 业务口径描述，LLM 理解语义的关键依据

    -- 2.2 节点类型 (核心分类)
    meta_type       VARCHAR(20) NOT NULL,
    -- 枚举值:
    -- 'entity'   (实体: 公司, 人物, 基金)
    -- 'event'    (事件: 违约, 诉讼, 调研)
    -- 'field'    (字段: 营收, 日期, 行业)
    -- 'relation' (关系: 供应商, 子公司)

    owner_id        BIGINT NULL,
    -- 归属父节点 ID。
    -- 用于强从属关系 (如: "营收" 字段属于 "财务报表" 实体/宽表)。
    -- 对于独立存在的实体(如 "公司")或关系(如 "供应商")，此字段通常为 NULL。

    -- 2.3 核心数据分类
    data_class      VARCHAR(20) NOT NULL,
    -- 枚举值说明:
    -- 'metric'    指标: 数值型。LLM 会尝试对其进行 SUM/AVG 等聚合计算。如: 营收, 收盘价, 涨跌幅
    -- 'dimension' 维度: 枚举/离散/标识/日期。LLM 会将其用于 WHERE 筛选或 GROUP BY 分组。如: 行业, 年份, 股票代码, 企业ID
    -- 'text'      文本: 说明性长文本。LLM 仅将其作为结果字段 SELECT 出来展示，或用于 RAG 检索。如: 公司简介, 经营范围
    -- 'group'     分组: 结构化对象/容器节点，不直接参与计算和筛选，用于组织下属字段。如: company, company.base

    value_type      VARCHAR(50) NULL,      -- 数据类型: string, int, decimal, date, boolean, jsonb
    unit            VARCHAR(50) NULL,      -- 单位: CNY, USD, %, 次 (仅 data_class = 'metric' 时有效)

    -- 2.4 标识位
    is_identifier   BOOLEAN NOT NULL DEFAULT FALSE, -- 是否为唯一标识符 (如 Ticker, 统一社会信用代码, 身份证号)

    -- 2.5 生命周期管理
    status          VARCHAR(20) NOT NULL DEFAULT 'active', -- active(生效), deprecated(弃用), draft(草稿)
    created_at      TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at      TIMESTAMPTZ NULL,

    -- 约束
    CONSTRAINT uq_biz_metadata_code UNIQUE (code)
);

-- 索引
CREATE INDEX idx_biz_metadata_owner_id ON biz_metadata(owner_id);
CREATE INDEX idx_biz_metadata_meta_type ON biz_metadata(meta_type);
CREATE INDEX idx_biz_metadata_status ON biz_metadata(status);
CREATE INDEX idx_biz_metadata_name ON biz_metadata(name); -- 加速 NLIR 名称匹配

-- 触发器: 自动更新 updated_at
CREATE TRIGGER update_biz_metadata_modtime
    BEFORE UPDATE ON biz_metadata
    FOR EACH ROW EXECUTE FUNCTION update_timestamp_column();

-- 注释
COMMENT ON TABLE biz_metadata IS '统一业务语义元数据定义表';
COMMENT ON COLUMN biz_metadata.code IS '业务编码 (全局唯一)，建议格式：domain.entity.field，如 company.finance.revenue';
COMMENT ON COLUMN biz_metadata.name IS '标准业务名称 (中文)，如 "营业收入"。对应 NLIR 协议中 name 字段。';
COMMENT ON COLUMN biz_metadata.description IS '业务含义/口径描述。例如："指企业在从事主要业务活动中取得的收入"。';
COMMENT ON COLUMN biz_metadata.meta_type IS '节点类型枚举：entity(实体), event(事件), field(字段), relation(关系)。';
COMMENT ON COLUMN biz_metadata.data_class IS '数据核心分类：metric(指标-数值可聚合), dimension(维度-筛选/分组/日期/ID), text(文本-描述/检索)。';
COMMENT ON COLUMN biz_metadata.is_identifier IS '是否为唯一标识符，用于唯一确定一个实体。';
```

---

### 2.2 表：`biz_metadata_alias`（自然语言映射表）

解决“多词一义”的自然语言别名问题，为 NLIR 的 Schema Linking 提供支持。

- 一条标准元数据可对应多个别名。
- 支持来源标记和权重控制。

```sql
CREATE TABLE biz_metadata_alias (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    metadata_id   BIGINT NOT NULL,       -- 关联 biz_metadata.id

    -- 别名定义
    alias         VARCHAR(255) NOT NULL, -- 自然语言别名/同义词

    -- 匹配属性
    source        VARCHAR(64) NOT NULL DEFAULT 'manual',
    -- 枚举值: 'manual'(人工), 'auto_mine'(挖掘), 'log'(日志), 'embedding'(向量生成)

    weight        INTEGER NOT NULL DEFAULT 0,            -- 匹配权重 (0-100)，数值越高优先级越高
    is_primary    BOOLEAN NOT NULL DEFAULT FALSE,        -- 是否为首选别名 (用于生成回答时指代该指标)

    language      VARCHAR(16) NOT NULL DEFAULT 'zh-CN',

    created_at    TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at    TIMESTAMPTZ NULL
);

-- 索引
CREATE INDEX idx_metadata_alias_mid ON biz_metadata_alias(metadata_id);
CREATE INDEX idx_metadata_alias_alias ON biz_metadata_alias(alias);

-- 触发器
CREATE TRIGGER update_biz_metadata_alias_modtime
    BEFORE UPDATE ON biz_metadata_alias
    FOR EACH ROW EXECUTE FUNCTION update_timestamp_column();

-- 注释
COMMENT ON TABLE biz_metadata_alias IS '业务元数据别名/同义词表 (用于 NLIR 解析)';
COMMENT ON COLUMN biz_metadata_alias.metadata_id IS '关联的标准元数据 ID';
COMMENT ON COLUMN biz_metadata_alias.alias IS '自然语言别名。如标准名 "营业收入"，此处可存 "营收", "销售额", "Top Line" 等。';
```

---

### 2.3 表：`biz_metadata_relation`（元数据拓扑关系表）

定义元数据之间的拓扑关系，包括：物理 JOIN、业务图谱边、指标血缘。

```sql
CREATE TABLE biz_metadata_relation (
    id               BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- 连接两端
    from_metadata_id BIGINT NOT NULL, -- 起点 ID
    to_metadata_id   BIGINT NOT NULL, -- 终点 ID

    -- 关系分类 (Top Level)
    category         VARCHAR(32) NOT NULL,
    -- 枚举值:
    -- 'PHYSICAL_JOIN': 物理表关联 (用于 SQL 生成: ON t1.col = t2.col)
    -- 'GRAPH_EDGE':    业务图谱关系 (用于图查询: MATCH (a)-[r]->(b))
    -- 'LINEAGE':       逻辑血缘/计算依赖 (如 A derived from B)

    -- 具体关系编码 (Sub Type)
    relation_code    VARCHAR(64) NOT NULL,
    -- 示例: 'foreign_key', 'supplier_of', 'invest_in', 'derived_from'

    -- 拓扑属性
    direction_mode   VARCHAR(20) NOT NULL DEFAULT 'directed',
    -- 枚举: 'directed'(有向), 'symmetric'(对称/无向)

    cardinality      VARCHAR(10) NULL,
    -- 枚举: '1:1', '1:N', 'N:1', 'N:N' (指导 SQL Join 策略)

    description      TEXT NULL, -- 关系说明

    created_at       TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at       TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at       TIMESTAMPTZ NULL,

    -- 约束: 同一对节点之间，同一种具体关系代码只能存在一条
    CONSTRAINT uq_metadata_relation UNIQUE (from_metadata_id, to_metadata_id, relation_code)
);

-- 索引
CREATE INDEX idx_rel_category ON biz_metadata_relation(category);
CREATE INDEX idx_rel_from ON biz_metadata_relation(from_metadata_id);
CREATE INDEX idx_rel_to ON biz_metadata_relation(to_metadata_id);

-- 触发器
CREATE TRIGGER update_biz_metadata_relation_modtime
    BEFORE UPDATE ON biz_metadata_relation
    FOR EACH ROW EXECUTE FUNCTION update_timestamp_column();

-- 注释
COMMENT ON TABLE biz_metadata_relation IS '元数据拓扑关系表 (定义外键/图谱边/血缘关系)';
COMMENT ON COLUMN biz_metadata_relation.from_metadata_id IS '起点元数据 ID，如外键字段、图谱边 Source 节点、派生指标等。';
COMMENT ON COLUMN biz_metadata_relation.to_metadata_id IS '终点元数据 ID，如主键字段、图谱边 Target 节点、原始指标等。';
COMMENT ON COLUMN biz_metadata_relation.category IS '关系大类：PHYSICAL_JOIN(物理连接), GRAPH_EDGE(业务图谱), LINEAGE(血缘)。';
COMMENT ON COLUMN biz_metadata_relation.relation_code IS '具体关系编码，如 foreign_key(外键), supplier_of(供应商)。';
COMMENT ON COLUMN biz_metadata_relation.direction_mode IS '方向模式：directed(A->B，如投资), symmetric(A-B，如战略合作)。';
```

---

### 2.4 表：`metadata_category`（元数据业务分类定义）

为元数据提供树状业务分类，用于主题域划分和前端导航。

```sql
CREATE TABLE metadata_category (
    id           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    code         VARCHAR(100) NOT NULL UNIQUE, -- 分类编码，如 company_basic/company_finance/company_risk
    name         VARCHAR(200) NOT NULL,        -- 分类名称，如 企业基本信息

    parent_id    BIGINT NULL,                  -- 父分类 ID，顶级为 NULL

    sort_order   INTEGER NOT NULL DEFAULT 0,   -- 同一父分类下的排序

    status       VARCHAR(20) NOT NULL DEFAULT 'active', -- 状态: active/inactive/deprecated

    icon         VARCHAR(100) NULL,            -- 前端图标标识(可选)
    description  TEXT NULL,                    -- 分类说明：业务含义、使用范围等

    created_at   TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 创建时间
    updated_at   TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 更新时间
    deleted_at   TIMESTAMPTZ NULL                                 -- 软删除时间，NULL 表示未删除
);

-- 索引
CREATE INDEX idx_metadata_category_parent ON metadata_category(parent_id);
CREATE INDEX idx_metadata_category_status ON metadata_category(status);

-- 触发器: 自动更新 updated_at
CREATE TRIGGER update_metadata_category_modtime
    BEFORE UPDATE ON metadata_category
    FOR EACH ROW EXECUTE FUNCTION update_timestamp_column();

-- 注释
COMMENT ON TABLE metadata_category IS '元数据业务分类定义';
COMMENT ON COLUMN metadata_category.code IS '分类编码，如 company_basic/company_finance/company_risk';
COMMENT ON COLUMN metadata_category.name IS '分类名称，如 企业基本信息';
COMMENT ON COLUMN metadata_category.parent_id IS '父分类 ID，顶级为 NULL';
COMMENT ON COLUMN metadata_category.sort_order IS '同一父分类下的排序';
COMMENT ON COLUMN metadata_category.status IS '状态: active/inactive/deprecated';
COMMENT ON COLUMN metadata_category.icon IS '前端图标标识(可选)';
COMMENT ON COLUMN metadata_category.description IS '分类说明：业务含义、使用范围等';
```

---

### 2.5 表：`metadata_category_mapping`（元数据与业务分类映射）

为 `biz_metadata` 与 `metadata_category` 提供多对多绑定关系。

```sql
CREATE TABLE metadata_category_mapping (
    metadata_id   BIGINT NOT NULL,             -- 元数据 ID, 关联 biz_metadata.id
    category_id   BIGINT NOT NULL,             -- 分类 ID, 关联 metadata_category.id

    is_primary    BOOLEAN NOT NULL DEFAULT FALSE, -- 是否该元数据的主分类
    weight        INTEGER NOT NULL DEFAULT 0,     -- 在该分类下的排序/权重

    created_at    TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 创建时间
    deleted_at    TIMESTAMPTZ NULL,                                -- 软删除时间，NULL 表示未删除

    PRIMARY KEY (metadata_id, category_id)
);

-- 索引
CREATE INDEX idx_mcm_category ON metadata_category_mapping(category_id);

-- 注释
COMMENT ON TABLE metadata_category_mapping IS '元数据与业务分类映射(支持一字段多归属)';
COMMENT ON COLUMN metadata_category_mapping.metadata_id IS '元数据 ID, 关联 biz_metadata.id';
COMMENT ON COLUMN metadata_category_mapping.category_id IS '分类 ID, 关联 metadata_category.id';
COMMENT ON COLUMN metadata_category_mapping.is_primary IS '是否该元数据的主分类';
COMMENT ON COLUMN metadata_category_mapping.weight IS '在该分类下的排序/权重';
```

---

## 3. 数据源与接口映射层（Data Source & API Mapping Layer）

该分层描述物理数据源、接口及其与统一语义元数据的映射关系，用于实现“语义 → 物理调用”的落地执行。

### 3.1 表：`biz_data_source`（物理数据源配置表）

抽象 Wind、内部库、第三方 REST API 等数据源，统一管理 BaseURL/连接串与鉴权信息。

```sql
CREATE TABLE biz_data_source (
    id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    code          VARCHAR(64) NOT NULL UNIQUE, -- 唯一标识: wind_api, internal_db
    name          VARCHAR(256) NOT NULL,

    type          VARCHAR(32) NOT NULL,        -- 枚举: 'api' (REST), 'database' (SQL)

    -- 连接配置，包含 BaseURL 和鉴权 Token 等
    -- API 示例: {"base_url": "https://api.example.com/v1", "headers": {"Authorization": "Bearer xxx"}}
    -- DB 示例:  {"host": "10.0.0.1", "port": 5432, "user": "root"}
    conn_config   JSONB NOT NULL,

    created_at    TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 注释
COMMENT ON TABLE biz_data_source IS '物理数据源配置表 (存放 BaseURL 和 Auth 等信息)';
COMMENT ON COLUMN biz_data_source.code IS '数据源唯一编码: 如 wind_api, internal_db';
COMMENT ON COLUMN biz_data_source.type IS '数据源类型: api(REST), database(SQL)';
```

---

### 3.2 表：`biz_api`（物理接口定义表）

在数据源之上抽象可调用的物理接口：
对 API 源，对应 HTTP 接口；对数据库源，对应表或逻辑查询入口。

```sql
CREATE TABLE biz_api (
    id             BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    data_source_id BIGINT NOT NULL,            -- 关联 biz_data_source.id

    code           VARCHAR(64) NOT NULL UNIQUE, -- 接口逻辑标识: company_profile
    name           VARCHAR(256) NOT NULL,       -- 接口名称

    -- 物理路径
    -- API: URL 路径 (如 "/company/getDetail")，会自动拼接 Source 的 base_url
    -- DB:  表名 (如 "t_company")
    endpoint       VARCHAR(512) NOT NULL,

    method         VARCHAR(10) NOT NULL DEFAULT 'GET', -- GET, POST, SELECT

    created_at     TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 注释
COMMENT ON TABLE biz_api IS '物理接口定义表 (存放 URL Path 或 表名)';
COMMENT ON COLUMN biz_api.data_source_id IS '关联的数据源 ID，对应 biz_data_source.id';
COMMENT ON COLUMN biz_api.endpoint IS '物理路径: 对 API 为 URL Path，对 DB 为表名或逻辑入口';
```

---

### 3.3 表：`biz_api_input`（API 入参映射表）

将统一语义字段映射到具体 API/SQL 的入参，用于构造请求。

```sql
CREATE TABLE biz_api_input (
    id             BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    api_id         BIGINT NOT NULL,            -- 关联 biz_api.id
    metadata_id    BIGINT NOT NULL,            -- 关联 biz_metadata (语义字段)

    -- 参数物理名称
    -- 如 "stockCode", "startDate", "limit"
    param_name     VARCHAR(128) NOT NULL,

    -- 参数位置 (REST API 场景)
    -- 'query':  拼接在 URL 后 (?id=1)
    -- 'body':   放在 JSON Body 中 (POST {"id": 1})
    -- 'path':   替换 URL 路径变量 (/user/{id})
    -- 'header': 放在 HTTP Header 中
    location       VARCHAR(20) NOT NULL DEFAULT 'query',

    required       BOOLEAN NOT NULL DEFAULT FALSE, -- 是否必填
    default_value  VARCHAR(128) NULL,             -- 默认值

    -- 约束: 一个接口中，一个语义字段只能对应一个入参
    CONSTRAINT uq_api_input UNIQUE (api_id, metadata_id)
);

-- 注释
COMMENT ON TABLE biz_api_input IS 'API 入参映射表 (用于构造 HTTP Request 或 SQL 参数)';
COMMENT ON COLUMN biz_api_input.api_id IS '接口 ID, 关联 biz_api.id';
COMMENT ON COLUMN biz_api_input.metadata_id IS '语义字段 ID, 关联 biz_metadata.id';
COMMENT ON COLUMN biz_api_input.param_name IS '参数物理名称，如 stockCode、startDate';
COMMENT ON COLUMN biz_api_input.location IS '参数位置: query, body, path, header';
```

---

### 3.4 表：`biz_api_output`（API 出参映射表）

将接口返回结构映射回统一语义字段，用于解析响应数据。

```sql
CREATE TABLE biz_api_output (
    id             BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    api_id         BIGINT NOT NULL,            -- 关联 biz_api.id
    metadata_id    BIGINT NOT NULL,            -- 关联 biz_metadata (语义字段)

    -- 取值路径
    -- API: JSONPath (如 "$.data.list[*].revenue")
    -- DB:  列名 (如 "total_revenue")
    json_path      VARCHAR(512) NOT NULL,

    -- 数据转换表达式 (可选)
    -- 简单的表达式，'value' 代表原始值
    -- 如: "value / 10000" (转万元), "value::TEXT" 等
    transform_expr VARCHAR(256) NULL,

    -- 约束: 一个接口中，一个语义字段只能对应一个出参
    CONSTRAINT uq_api_output UNIQUE (api_id, metadata_id)
);

-- 注释
COMMENT ON TABLE biz_api_output IS 'API 出参映射表 (用于解析 JSON Response 或 ResultSet)';
COMMENT ON COLUMN biz_api_output.api_id IS '接口 ID, 关联 biz_api.id';
COMMENT ON COLUMN biz_api_output.metadata_id IS '语义字段 ID, 关联 biz_metadata.id';
COMMENT ON COLUMN biz_api_output.json_path IS 'JSON 提取路径或数据库列名';
COMMENT ON COLUMN biz_api_output.transform_expr IS '数据转换表达式，作用于原始值 value';
```

---

## 4. 结构总览

- 语义元数据层 (`biz_metadata*`, `metadata_category*`) 描述“有哪些业务概念以及它们之间的语义关系和分类”。
- 数据源与接口映射层 (`biz_data_source`, `biz_api*`) 描述“数据从哪里来、通过什么接口获取，以及如何将接口入参/出参与语义字段对应”。
- NLIR 协议通过 `name` + `meta_type` 定位到 `biz_metadata`，由 Schema Linker 基于这些元数据与映射表选择合适的物理接口，并完成参数填充与结果解析。
