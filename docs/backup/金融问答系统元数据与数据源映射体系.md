# 金融问答系统元数据与数据源映射体系设计方案

## 一、建设背景与总体方案

### 1.1 建设目标

本方案旨在建立一套**统一、高可解释性、可扩展的元数据与数据源映射体系**，以支撑大模型（LLM）驱动的金融问答与查数系统。该体系通过建立清晰的**语义层**，彻底解决LLM与底层异构数据源（API、数据库）之间的强耦合问题，实现：

1. **语义统一**：将自然语言提问映射为标准的业务语义编码。
2. **查询透明**：系统能自动规划查询路径，并清晰地解释数据来源。
3. **灵活配置**：底层数据源或接口发生变更时，仅需修改映射层，不影响上层业务逻辑。

---

### 1.2 核心业务抽象（三大核心建模主体）

为确保模型的简洁性和严谨性，本方案将业务概念收敛为三类核心建模主体，并辅以关系描述。

1. **实体（Entity）**
    * **定义**：业务主体对象，是数据的逻辑挂载点和唯一标识（主键）。
    * **范例**：`company` (企业)、`person` (自然人/高管)、`bond` (债券)、`fund` (基金)、`region` (区域/省市)。

2. **事件（Event）**
    * **定义**：具有明确时间点的独立业务行为或历史记录。
    * **范例**：`event.default` (违约记录)、`event.lawsuit` (法律诉讼)、`event.rating_change` (评级变动)。
    * **特性**：**事件作为独立主体建模**，与实体天然具备**所属关系**，数据通常以列表形式存在。

3. **字段（Field）**
    * **定义**：挂载在实体或事件上的具体属性或度量。
    * **分类**：
        * **静态字段**：值不随时间频繁变化，如 `company.name`、`bond.code`。
        * **时序指标（Time-Series Metric）**：必须提供时间参数才能确定值的字段（如财务、宏观数据），如 `company.revenue`、`region.gdp`。

4. **关系（Relation）**
    * **定义**：连接两个**实体**的桥梁，用于描述复杂的图结构。
    * **范例**：`company` 与 `company` 的母子公司关系，`fund` 与 `person` 的基金经理关系，`bond` 与 `company` 的发行方关系等。

---

## 二、业务语义层：统一元数据中心（biz_metadata）

`biz_metadata` 是本系统的语义字典，负责定义所有业务概念及其结构。

### 2.1 核心表结构定义

| 字段名 | 含义 | 示例值 | 备注 |
| :--- | :--- | :--- | :--- |
| **code** | 元数据编码 | `company.revenue` | 全局唯一标识符 |
| **node_type** | 节点类型 | `entity` / `field` / **`event`** / `relation` | 区分四大建模主体 |
| **owner_id** | 归属主体 ID | `company` 或 `event.default` | 字段的归属（实体或事件） |
| **data_structure** | 数据结构 | `scalar` / `time_series` / `list<scalar>` | 区分值类型：标量、时序序列等 |
| **required_args** | 必需参数 | `["date", "period"]` | 针对时序指标和列表字段 |

### 2.2 建模范例

| 语义编码（Code） | 节点类型 | 归属主体 | 数据结构 | 必需参数 | 描述 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **company** | `entity` | `null` | `null` | `null` | **核心实体：** 企业 |
| **bond** | `entity` | `null` | `null` | `null` | **核心实体：** 债券 |
| `company.revenue` | `field` | `company` | `time_series` | `["date", "period"]` | **时序指标：** 营收（财务数据） |
| **event.default** | **`event`** | `null` | `null` | `null` | **独立事件主体：** 违约记录 |
| `event.default.date` | `field` | `event.default` | `scalar` | `null` | 事件字段：违约日期 |
| `company.parent` | **`relation`** | `company` | `N:1` | `null` | **关系：** 母公司与子公司 |

### 2.3 关系（Relation）的应用范围

`Relation` 节点专注于描述实体间的复杂网络结构，支持 LLM 的多跳推理。

| 关系编码（Relation Code） | From Entity | To Entity | Relation Type | 逻辑说明 |
| :--- | :--- | :--- | :--- | :--- |
| `company.parent` | `company` | `company` | `N:1` | 母子公司（实体自关联） |
| `bond.issuer` | `bond` | `company` | `N:1` | 债券的发行方（债券实体与企业实体关联） |
| `fund.manager` | `fund` | `person` | `N:1` | 基金的管理人（基金实体与自然人实体关联） |
| `region.contained_companies` | `region` | `company` | `1:N` | 区域管辖（查询某区域下的所有企业） |

---

## 三、数据源与接口映射层（Mapping Layer）

### 3.1 接口登记：biz_api

记录底层物理接口信息，包括 URL、Method、接口参数定义等。

### 3.2 输出映射：biz_api_output_mapping

将语义层的**字段**和**事件**编码直接映射到物理接口的 JSON 路径。

| API 编码 | JSON 路径 | 语义编码 (`metadata_code`) | 逻辑说明 |
| :--- | :--- | :--- | :--- |
| `api_company_base_info` | `$.data.regCap` | `company.reg_capital` | 静态字段映射 |
| `api_finance_report` | `$.data.revenue` | `company.revenue` | 时序指标字段映射 |
| `api_get_default_list` | `$.events[*]` | `event.default` | **事件数据映射**，需解析列表 |

### 3.3 所属关系与过滤映射

事件与实体的所属关系、时序指标的参数，都通过 Query Planner 映射到底层接口的过滤参数。

* **时序指标下推**：查询时序指标（如营收）的日期和周期参数，自动映射为底层接口的请求参数。
* **事件所属过滤**：查询事件（如违约记录）时，Planner 自动将所属实体的 ID 作为过滤参数下推给事件接口，确保数据归属正确。

---

## 四、方案总结与优势

### 4.1 方案优势总结

1. **架构精简**：**完全取消视图（View）概念**，核心建模收敛至实体、事件、字段三大主体，极大降低了元数据维护和LLM理解的复杂度。
2. **业务严谨**：**事件独立建模**，解决了 1 对 N 数据结构问题；财务数据定义为**时序指标**，符合业务查询习惯。
3. **图结构支持**：`Relation` 节点专注于描述实体间的复杂关联，为LLM的多跳推理奠定基础。

### 4.2 实施推进建议

1. **第一阶段：核心域 PoC**：
    * 选定“企业 + 财务 + 违约/评级事件”为首批接入数据域。
    * 完成核心元数据建模、关系建模、接口映射，支撑典型金融问答场景。
2. **第二阶段：元数据管理平台**：
    * 构建元数据可视化管理后台，支持业务和数据团队维护和审批实体、字段、事件和接口映射。
3. **第三阶段：横向扩展**：
    * 逐步扩展到债券、基金、区域等更多实体，并实现基于 `Relation` 表的复杂图查询能力。
